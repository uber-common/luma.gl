# Writing Shadertools Shader Modules


## Usage


This object can be used as shader module directly:

```js
assembleShaders(gl, {..., modules: [MY_SHADER_MODULE]});
```

Alternatively, you can register it so that it can be referred to by name.

```js
registerShaderModules([module]);
assembleShaders(gl, {..., modules: ['my-module']});
```


## Structure of a Shader Module

### Shader Module Type

A shader module is either:

* **Generic** - a set of generic GLSL functions that can be included either in a fragment shader or a vertex shader (or both). The `fp64` module is a good example of this type of module.
* **Functional** - Contains specific vertex and/or fragment shader "chunks", often set up so that the vertex shader part sets up a `varying` used by the fragment shader part.


### Shader Module Descriptor

To define a new shader module, you create a descriptor object that brings together all the necessary pieces:

```js
export const MY_SHADER_MODULE = {
  name: 'my-shader-module',
  vs: '...',
  fs: '...',
  dependencies: [],
  deprecations: [],
  getUniforms
};
```

Descriptor objects can define the following fields:

* `name` (*String*, Required) - The name of the shader module.
* `vs` - (String | null)
* `fs` - (String | null)
* `getUniforms` JavaScript function that maps JavaScript parameter keys to uniforms used by this module
* `dependencies` (*Array*) - a list of other shader modules that this module is dependent on
* `deprecations` (*Array*) - a list of deprecated APIs.

If `deprecations` is supplied, `assembleShaders` will scan GLSL source code for the deprecated constructs and issue a console warning if found. Each API is described in the following format:
  - `type`: `uniform <type>` or `function`
  - `old`: name of the deprecated uniform/function
  - `new`: name of the new uniform/function
  - `deprecated`: whether the old API is still supported.


### GLSL Code

The GLSL code for a shader module typically contains:

* a mix of uniform and varying declarations
* one or more GLSL function definitions


### getUniforms

Each shader module provides a method to get a map of uniforms for the shader. This function will be called with two arguments:

* `opts` - the module settings to update. This argument may not be provided when `getUniforms` is called to generate a set of default uniform values.
* `context` - the uniforms generated by this module's dependencies.

The function should return a JavaScript object with keys representing uniform names and values representing uniform values.

The function should expect the shape of the dependency uniforms to vary based on what's passed in `opts`. This behavior is intended because we only want to recalculate a uniform if the uniforms that it depends on are changed. An example is the `project` and `project64` modules in deck.gl. When `opts.viewport` is provided, `project64` will receive the updated projection matrix generated by the `project` module. If `opts.viewport` is empty, then the `project` module generates nothing and so should `project64`.


### Platform Detection

Also does platform detection and injects `#define` statements enabling your shader to conditionally use code.
